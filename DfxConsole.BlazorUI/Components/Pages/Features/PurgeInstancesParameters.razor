@using DfxConsole.BlazorUI.Constants
@using DfxConsole.BlazorUI.Models

<div class="row">
    <div class="col-md-6 mb-3">
        <label class="form-label">Created Time From (Local)<span class="text-danger">*</span></label>
        <input type="datetime-local" class="form-control" @bind="_createdTimeFrom" />
    </div>
    <div class="col-md-6 mb-3">
        <label class="form-label">Created Time To (Local)</label>
        <input type="datetime-local" class="form-control" @bind="_createdTimeTo" />
    </div>
</div>
<div class="row">
    <div class="col-md-6 mb-3">
        <label class="form-label">Runtime Status</label>
        <div class="compact-checkboxes">
            @foreach (var status in RuntimeStatus.GetAll())
            {
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="@("purge_" + status)"
                           checked="@_selectedStatuses.Contains(status)"
                           @onchange="@(e => ToggleStatus(status, (bool)e.Value!))" />
                    <label class="form-check-label" for="@("purge_" + status)">@status</label>
                </div>
            }
        </div>
    </div>
</div>
<button class="btn btn-danger" @onclick="Execute" disabled="@(!IsConfigValid || !_createdTimeFrom.HasValue)">Execute</button>

<style>
    .compact-checkboxes .form-check {
        padding-left: 1.25rem;
        margin-bottom: 0.25rem;
    }

    .compact-checkboxes .form-check-input {
        width: 1rem;
        height: 1rem;
        margin-top: 0.15rem;
    }

    .compact-checkboxes .form-check-label {
        font-size: 0.875rem;
        line-height: 1.3;
        padding-left: 0.25rem;
    }
</style>

@code {
    [Parameter] public EventCallback<PurgeInstancesParams> OnExecute { get; set; }
    [Parameter] public bool IsConfigValid { get; set; } = false;

    private DateTime? _createdTimeFrom;
    private DateTime? _createdTimeTo;
    private List<string> _selectedStatuses = new();

    private async Task Execute()
    {
        if (!_createdTimeFrom.HasValue)
        {
            return;
        }

        await OnExecute.InvokeAsync(new PurgeInstancesParams(
            _createdTimeFrom.Value,
            _createdTimeTo,
            _selectedStatuses.Any() ? _selectedStatuses : null));
    }

    private void ToggleStatus(string status, bool isChecked)
    {
        if (isChecked)
        {
            _selectedStatuses.Add(status);
        }
        else
        {
            _selectedStatuses.Remove(status);
        }
    }

    public record PurgeInstancesParams(
        DateTime CreatedTimeFrom,
        DateTime? CreatedTimeTo,
        List<string>? RuntimeStatus);
}