@using DfxConsole.BlazorUI.Constants
@using DfxConsole.BlazorUI.Models

<div class="row">
    <div class="col-md-6 mb-3">
        <label class="form-label">Created Time From</label>
        <input type="datetime-local" class="form-control" @bind="_createdTimeFrom" />
    </div>
    <div class="col-md-6 mb-3">
        <label class="form-label">Created Time To</label>
        <input type="datetime-local" class="form-control" @bind="_createdTimeTo" />
    </div>
</div>
<div class="row">
    <div class="col-md-6 mb-3">
        <label class="form-label">Runtime Status</label>
        <div class="compact-checkboxes">
            @foreach (var status in RuntimeStatus.GetAll())
            {
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="@status"
                           checked="@_selectedStatuses.Contains(status)"
                           @onchange="@(e => ToggleStatus(status, (bool)e.Value!))" />
                    <label class="form-check-label" for="@status">@status</label>
                </div>
            }
        </div>
    </div>
    <div class="col-md-6 mb-3">
        <label class="form-label">Instance ID Prefix</label>
        <input type="text" class="form-control" @bind="_instanceIdPrefix" />

        <div class="form-check mt-3 compact-checkboxes">
            <input class="form-check-input" type="checkbox" id="showInput" @bind="_showInput" />
            <label class="form-check-label" for="showInput">Show Input</label>
        </div>

        <label class="form-label mt-3">Top (Max Results)</label>
        <input type="number" class="form-control" @bind="_top" min="1" />
    </div>
</div>
<button class="btn btn-primary" @onclick="Execute" disabled="@(!IsConfigValid)">Execute</button>

<style>
    .compact-checkboxes .form-check {
        padding-left: 1.25rem;
        margin-bottom: 0.25rem;
    }

    .compact-checkboxes .form-check-input {
        width: 1rem;
        height: 1rem;
        margin-top: 0.15rem;
    }

    .compact-checkboxes .form-check-label {
        font-size: 0.875rem;
        line-height: 1.3;
        padding-left: 0.25rem;
    }
</style>

@code {
    [Parameter, EditorRequired] public EventCallback<GetInstancesParams> OnExecute { get; set; }
    [Parameter] public bool IsConfigValid { get; set; } = false;

    private DateTime? _createdTimeFrom;
    private DateTime? _createdTimeTo;
    private List<string> _selectedStatuses = new();
    private string _instanceIdPrefix = string.Empty;
    private bool _showInput = false;
    private int? _top;

    private async Task Execute()
    {
        await OnExecute.InvokeAsync(new GetInstancesParams(
            _createdTimeFrom,
            _createdTimeTo,
            _selectedStatuses.Any() ? _selectedStatuses : null,
            string.IsNullOrEmpty(_instanceIdPrefix) ? null : _instanceIdPrefix,
            _showInput,
            _top,
            null)); // Initial call with no continuation token
    }

    private void ToggleStatus(string status, bool isChecked)
    {
        if (isChecked)
        {
            _selectedStatuses.Add(status);
        }
        else
        {
            _selectedStatuses.Remove(status);
        }
    }

    public record GetInstancesParams(
        DateTime? CreatedTimeFrom,
        DateTime? CreatedTimeTo,
        List<string>? RuntimeStatus,
        string? InstanceIdPrefix,
        bool ShowInput,
        int? Top,
        string? ContinuationToken);
}