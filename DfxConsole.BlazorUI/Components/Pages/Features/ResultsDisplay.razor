@using System.Text.Json
@using DfxConsole.BlazorUI.Components.Constants
@using DfxConsole.BlazorUI.Components.Pages.Features
@using DfxConsole.BlazorUI.Components.Shared
@using DfxConsole.BlazorUI.Constants
@using DfxConsole.BlazorUI.Models
@using DfxConsole.BlazorUI.Services
@inject LocalStorageService LocalStorageService
@inject IJSRuntime JSRuntime

@if (!string.IsNullOrEmpty(Result))
{
    <div class="row">
        <div class="col-12">
            @if (_viewMode == ViewMode.Table && CanShowTableView)
            {
                <div class="card shadow-sm">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-table me-2"></i>Results
                                @if (RowCount.HasValue)
                                {
                                    <span class="badge bg-primary text-white ms-2">@RowCount.Value @(RowCount.Value == 1 ? "row" : "rows")</span>
                                }
                            </h5>
                            <div class="d-flex gap-2">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-secondary"
                                            @onclick="() => _viewMode = ViewMode.Table">
                                        <span class="bi bi-table"></span> Table
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary"
                                            @onclick="() => _viewMode = ViewMode.Json">
                                        <span class="bi bi-code"></span> JSON
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive result-container">
                            <table class="table table-hover mb-0">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        @if (CurrentResultType == ResultType.Instance)
                                        {
                                            <th>Instance ID</th>
                                            <th>Name</th>
                                            <th class="sortable" @onclick="() => SortInstances(InstanceSortColumn.Status)">
                                                Status
                                                @if (_instanceSortColumn == InstanceSortColumn.Status)
                                                {
                                                    <i class="bi bi-@(_instanceSortAscending ? "arrow-up" : "arrow-down")"></i>
                                                }
                                            </th>
                                            <th class="sortable" @onclick="() => SortInstances(InstanceSortColumn.CreatedTime)">
                                                Created Time
                                                @if (_instanceSortColumn == InstanceSortColumn.CreatedTime)
                                                {
                                                    <i class="bi bi-@(_instanceSortAscending ? "arrow-up" : "arrow-down")"></i>
                                                }
                                            </th>
                                            <th class="sortable" @onclick="() => SortInstances(InstanceSortColumn.LastUpdatedTime)">
                                                Last Updated
                                                @if (_instanceSortColumn == InstanceSortColumn.LastUpdatedTime)
                                                {
                                                    <i class="bi bi-@(_instanceSortAscending ? "arrow-up" : "arrow-down")"></i>
                                                }
                                            </th>
                                            <th>Actions</th>
                                        }
                                        else
                                        {
                                            <th>Entity Name</th>
                                            <th>Entity Key</th>
                                            <th class="sortable" @onclick="() => SortEntities()">
                                                Last Operation Time
                                                <i class="bi bi-@(_entitySortAscending ? "arrow-up" : "arrow-down")"></i>
                                            </th>
                                            <th>Actions</th>
                                        }
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (CurrentResultType == ResultType.Instance)
                                    {
                                        @foreach (var instance in _sortedInstances)
                                        {
                                            <tr>
                                                <td title="@instance.InstanceId">
                                                    @instance.InstanceId
                                                </td>
                                                <td title="@instance.Name">
                                                    @instance.Name
                                                </td>
                                                <td>
                                                    <span class="badge @GetStatusBadgeClass(instance.RuntimeStatus)">
                                                        @instance.RuntimeStatus
                                                    </span>
                                                </td>
                                                <td class="text-nowrap">@FormatDateTime(instance.CreatedTime)</td>
                                                <td class="text-nowrap">@FormatDateTime(instance.LastUpdatedTime)</td>
                                                <td>
                                                    <div class="d-flex gap-1">
                                                        <button class="btn btn-sm btn-outline-primary"
                                                                @onclick="() => ShowInstanceDetailViewers(instance)"
                                                                title="View details in popup">
                                                            <span class="bi bi-eye"></span> Details
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-secondary"
                                                                @onclick="() => OpenInstanceInNewTab(instance.InstanceId)"
                                                                title="Open in new tab">
                                                            <span class="bi bi-box-arrow-up-right"></span>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    }
                                    else
                                    {
                                        @foreach (var entity in _sortedEntities)
                                        {
                                            <tr>
                                                <td title="@entity.EntityId.Name">
                                                    @entity.EntityId.Name
                                                </td>
                                                <td title="@entity.EntityId.Key">
                                                    @entity.EntityId.Key
                                                </td>
                                                <td class="text-nowrap">@FormatDateTime(entity.LastOperationTime)</td>
                                                <td>
                                                    <div class="d-flex gap-1">
                                                        <button class="btn btn-sm btn-outline-primary" 
                                                                @onclick="() => ShowEntityDetails(entity)"
                                                                title="View details in popup">
                                                            <span class="bi bi-eye"></span> Details
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-secondary"
                                                                @onclick="() => OpenEntityInNewTab(entity.EntityId.Name, entity.EntityId.Key)"
                                                                title="Open in new tab">
                                                            <span class="bi bi-box-arrow-up-right"></span>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                    @if (SupportsPagination && (HasPreviousPage || HasNextPage))
                    {
                        <div class="card-footer d-flex justify-content-between align-items-center">
                            <button class="btn btn-sm btn-outline-primary"
                                    @onclick="() => OnLoadPreviousPage.InvokeAsync()"
                                    disabled="@(!HasPreviousPage || IsLoading)">
                                <span class="bi bi-chevron-left"></span> Previous
                            </button>
                            <span class="text-muted">Page @(CurrentPageIndex + 1)</span>
                            <button class="btn btn-sm btn-outline-primary"
                                    @onclick="() => OnLoadNextPage.InvokeAsync()"
                                    disabled="@(!HasNextPage || IsLoading)">
                                Next <span class="bi bi-chevron-right"></span>
                            </button>
                        </div>
                    }
                </div>
            }
            else
            {
                <CodeViewer Content="@Result"
                            Icon="table"
                            HeaderClass=""
                            LanguageClass="language-json"
                            MaxHeight="calc(100vh - 400px)"
                            MinHeight="150px"
                            ShowCopyButton="true">
                    <AdditionalHeaderContent>
                        @if (CanShowTableView)
                        {
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-secondary"
                                        @onclick="() => _viewMode = ViewMode.Table">
                                    <span class="bi bi-table"></span> Table
                                </button>
                                <button class="btn btn-sm btn-outline-secondary"
                                        @onclick="() => _viewMode = ViewMode.Json">
                                    <span class="bi bi-code"></span> JSON
                                </button>
                            </div>
                        }
                    </AdditionalHeaderContent>
                </CodeViewer>
                @if (SupportsPagination && (HasPreviousPage || HasNextPage))
                {
                    <div class="card shadow-sm mt-2">
                        <div class="card-footer d-flex justify-content-between align-items-center">
                            <button class="btn btn-sm btn-outline-primary"
                                    @onclick="() => OnLoadPreviousPage.InvokeAsync()"
                                    disabled="@(!HasPreviousPage || IsLoading)">
                                <span class="bi bi-chevron-left"></span> Previous
                            </button>
                            <span class="text-muted">Page @(CurrentPageIndex + 1)</span>
                            <button class="btn btn-sm btn-outline-primary"
                                    @onclick="() => OnLoadNextPage.InvokeAsync()"
                                    disabled="@(!HasNextPage || IsLoading)">
                                Next <span class="bi bi-chevron-right"></span>
                            </button>
                        </div>
                    </div>
                }
            }
        </div>
    </div>
}

@if (_selectedInstance != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title d-flex align-items-center">
                        <i class="bi bi-diagram-3-fill me-2"></i>
                        <span>Instance Details</span>
                        <span class="badge bg-primary text-white ms-3 font-monospace">@_selectedInstance.InstanceId</span>
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseInstanceDetailViewers"></button>
                </div>
                <div class="modal-body">
                    <InstanceDetailViewer @key="@_selectedInstance.InstanceId" Instance="@_selectedInstance" ShowQuickInfo="true" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseInstanceDetailViewers">Close</button>
                </div>
            </div>
        </div>
    </div>
}

@if (_selectedEntity != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title d-flex align-items-center">
                        <i class="bi bi-box-fill me-2"></i>
                        <span>Entity Details</span>
                        <span class="badge bg-primary text-white ms-3">@_selectedEntity.EntityId.Name</span>
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseEntityDetails"></button>
                </div>
                <div class="modal-body">
                    <EntityDetailViewer @key="@($"{_selectedEntity.EntityId.Name}_{_selectedEntity.EntityId.Key}")" Entity="@_selectedEntity" ShowQuickInfo="true" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseEntityDetails">Close</button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .table-responsive {
        background-color: white;
    }

    .result-container {
        max-height: calc(100vh - 400px);
        min-height: 150px;
        overflow: auto;
        background-color: white;
    }

        .result-container table {
            font-size: var(--font-size-base);
            table-layout: auto;
            white-space: nowrap;
        }

            .result-container table th {
                font-size: var(--font-size-base);
                padding: 0.5rem 0.75rem;
                white-space: nowrap;
            }

            .result-container table td {
                font-size: var(--font-size-base);
                padding: 0.5rem 0.75rem;
            }

    .sticky-top {
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .sortable {
        cursor: pointer;
        user-select: none;
    }

        .sortable:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

    @@media (max-width: 991.98px) {
        .result-container {
            max-height: 400px;
        }
    }
</style>

@code {
    [Parameter] public string Result { get; set; } = string.Empty;
    [Parameter] public bool CanShowTableView { get; set; }
    [Parameter] public bool IsLoading { get; set; }
    [Parameter] public ResultType CurrentResultType { get; set; }
    [Parameter] public List<InstanceInfo> Instances { get; set; } = new();
    [Parameter] public List<EntityInfo> Entities { get; set; } = new();
    [Parameter] public bool SupportsPagination { get; set; }
    [Parameter] public bool HasPreviousPage { get; set; }
    [Parameter] public bool HasNextPage { get; set; }
    [Parameter] public int CurrentPageIndex { get; set; }
    [Parameter] public int? RowCount { get; set; }
    [Parameter] public EventCallback OnLoadPreviousPage { get; set; }
    [Parameter] public EventCallback OnLoadNextPage { get; set; }

    private ViewMode _viewMode = ViewMode.Table;
    private InstanceInfo? _selectedInstance = null;
    private EntityInfo? _selectedEntity = null;

    // Sorting state for instances
    private InstanceSortColumn _instanceSortColumn = InstanceSortColumn.CreatedTime;
    private bool _instanceSortAscending = true;
    private List<InstanceInfo> _sortedInstances = new();

    // Sorting state for entities
    private bool _entitySortAscending = true;
    private List<EntityInfo> _sortedEntities = new();

    public enum ViewMode
    {
        Table,
        Json
    }

    private enum InstanceSortColumn
    {
        Status,
        CreatedTime,
        LastUpdatedTime
    }

    protected override void OnParametersSet()
    {
        base.OnParametersSet();

        // Always reset to Table view on render
        _viewMode = ViewMode.Table;

        if (CurrentResultType == ResultType.Instance)
        {
            ApplyInstanceSort();
        }
        else
        {
            ApplyEntitySort();
        }
    }

    private void SortInstances(InstanceSortColumn column)
    {
        if (_instanceSortColumn == column)
        {
            _instanceSortAscending = !_instanceSortAscending;
        }
        else
        {
            _instanceSortColumn = column;
            _instanceSortAscending = true;
        }

        ApplyInstanceSort();
    }

    private void ApplyInstanceSort()
    {
        if (Instances == null || !Instances.Any())
        {
            _sortedInstances = new List<InstanceInfo>();
            return;
        }

        IEnumerable<InstanceInfo> sorted = _instanceSortColumn switch
        {
            InstanceSortColumn.Status => _instanceSortAscending
                ? Instances.OrderBy(i => i.RuntimeStatus ?? string.Empty)
                : Instances.OrderByDescending(i => i.RuntimeStatus ?? string.Empty),
            InstanceSortColumn.CreatedTime => _instanceSortAscending
                ? Instances.OrderBy(i => ParseDateTime(i.CreatedTime) ?? DateTime.MaxValue)
                : Instances.OrderByDescending(i => ParseDateTime(i.CreatedTime) ?? DateTime.MinValue),
            InstanceSortColumn.LastUpdatedTime => _instanceSortAscending
                ? Instances.OrderBy(i => ParseDateTime(i.LastUpdatedTime) ?? DateTime.MaxValue)
                : Instances.OrderByDescending(i => ParseDateTime(i.LastUpdatedTime) ?? DateTime.MinValue),
            _ => Instances
        };

        _sortedInstances = sorted.ToList();
    }

    private void SortEntities()
    {
        _entitySortAscending = !_entitySortAscending;
        ApplyEntitySort();
    }

    private void ApplyEntitySort()
    {
        if (Entities == null || !Entities.Any())
        {
            _sortedEntities = new List<EntityInfo>();
            return;
        }

        _sortedEntities = _entitySortAscending
            ? Entities.OrderBy(e => ParseDateTime(e.LastOperationTime) ?? DateTime.MaxValue).ToList()
            : Entities.OrderByDescending(e => ParseDateTime(e.LastOperationTime) ?? DateTime.MinValue).ToList();
    }

    private DateTime? ParseDateTime(string? dateTime)
    {
        if (string.IsNullOrEmpty(dateTime))
        {
            return null;
        }

        if (DateTime.TryParse(dateTime, out var dt))
        {
            return dt;
        }

        return null;
    }

    private void ShowInstanceDetailViewers(InstanceInfo instance)
    {
        _selectedInstance = instance;
    }

    private void ShowEntityDetails(EntityInfo entity)
    {
        _selectedEntity = entity;
    }

    private void CloseInstanceDetailViewers()
    {
        _selectedInstance = null;
    }

    private void CloseEntityDetails()
    {
        _selectedEntity = null;
    }

    private async Task OpenInstanceInNewTab(string? instanceId)
    {
        if (string.IsNullOrWhiteSpace(instanceId))
        {
            return;
        }

        var url = $"/instances/{Uri.EscapeDataString(instanceId)}?showHistoryOutput=true&returnInternalServerErrorOnFailure=true&needsReload=true";
        await JSRuntime.InvokeVoidAsync("window.open", url, "_blank");
    }

    private async Task OpenEntityInNewTab(string entityName, string entityKey)
    {
        if (string.IsNullOrWhiteSpace(entityName) || string.IsNullOrWhiteSpace(entityKey))
        {
            return;
        }

        var url = $"/entities/{Uri.EscapeDataString(entityName)}/{Uri.EscapeDataString(entityKey)}?needsReload=true";
        await JSRuntime.InvokeVoidAsync("window.open", url, "_blank");
    }

    private string GetStatusBadgeClass(string status) => status?.ToLower() switch
    {
        var s when s == RuntimeStatus.Running.ToLower() || s == RuntimeStatus.Pending.ToLower() => "bg-primary",
        var s when s == RuntimeStatus.Completed.ToLower() => "bg-success",
        var s when s == RuntimeStatus.Failed.ToLower() => "bg-danger",
        var s when s == RuntimeStatus.Terminated.ToLower() => "bg-warning",
        var s when s == RuntimeStatus.Canceled.ToLower() => "bg-secondary",
        _ => "bg-secondary"
    };

    private string FormatDateTime(string? dateTime)
    {
        if (string.IsNullOrEmpty(dateTime))
        {
            return "N/A";
        }

        if (DateTime.TryParse(dateTime, out var dt))
        {
            return dt.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss");
        }

        return dateTime;
    }

    private string GetFullJson(object obj)
    {
        return JsonSerializer.Serialize(obj, new JsonSerializerOptions
        {
            WriteIndented = true,
            PropertyNamingPolicy = JsonNamingPolicy.CamelCase
        });
    }
}